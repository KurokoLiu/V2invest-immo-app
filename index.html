<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Invest_IMMO • LMP / Simplifié + data.gouv (HTML) + Villes + CP/INSEE auto</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
<style>
:root{--bg:#0f1222;--fg:#f3f5ff;--muted:#aeb3d0;--card:#171a2e;--line:#252947;--accent:#6ea8fe;--accent2:#9c6efe;--ok:#3ddc84;--bad:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{padding:18px 22px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
header h1{margin:0;font-size:18px}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px 40px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.tab-btn{padding:10px 14px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:10px;cursor:pointer}
.tab-btn.active{outline:2px solid var(--accent)}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-1{grid-column:span 1}
label{display:block;margin:0 0 6px;color:var(--muted);font-size:13px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);background:#111428;color:var(--fg);border-radius:8px}
input[disabled]{opacity:.7}
.btn{padding:10px 14px;border:1px solid var(--line);background:#111428;color:#fff;border-radius:10px;cursor:pointer}
.btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
.kpi{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.kpi .item{grid-column:span 6;background:#111428;border:1px solid var(--line);border-radius:12px;padding:14px}
.kpi h3{margin:0 0 6px;font-size:14px;color:var(--muted)}
.val{font-size:20px;font-weight:700}
.pos{color:var(--ok)}.neg{color:var(--bad)}
.mono{font-family:ui-monospace,monospace;font-size:12px}
.sep{height:1px;background:var(--line);margin:16px 0}
.hint{color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;margin-right:6px}
@media(max-width:900px){.col-8,.col-6,.col-4,.col-3,.col-2,.col-1{grid-column:span 12}.kpi .item{grid-column:span 12}}
</style>
</head>
<body>
<header>
  <h1>Invest_IMMO • Mode fiscal LMP / Simplifié</h1>
  <span class="pill">HTML data.gouv + IR 2025 + CAPEX + Villes + CP/INSEE auto</span>
  <button class="btn" id="resetBtn">Réinitialiser</button>
</header>

<div class="wrap">
  <nav class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="saisie">Saisie</button>
    <button class="tab-btn" data-tab="fiscal">Fiscalité</button>
    <button class="tab-btn" data-tab="result">Résultats</button>
    <button class="tab-btn" data-tab="sources">Sources (HTML / CSV / JSON)</button>
  </nav>

  <!-- Saisie -->
  <section class="card" data-panel="saisie">
    <h2>Saisie du bien</h2>
    <div class="grid">
      <div class="col-6">
        <label>Ville (liste du classement)</label>
        <select id="city"></select>
        <div id="city_info" class="hint" style="margin-top:6px"></div>
      </div>

      <div class="col-3">
        <label>Code postal</label>
        <input id="cp" list="cp_options" placeholder="94340">
        <datalist id="cp_options"></datalist>
      </div>

      <div class="col-3">
        <label>Code INSEE (auto)</label>
        <input id="insee" disabled placeholder="—">
      </div>

      <div class="col-12"><div class="sep"></div></div>

      <div class="col-4"><label>Adresse</label><input id="address" placeholder="3 rue Exemple"></div>
      <div class="col-3"><label>Prix d’achat FAI (€)</label><input id="price" type="number"></div>
      <div class="col-2"><label>Surface (m²)</label><input id="surf" type="number"></div>
      <div class="col-1"><label>DPE</label><input id="dpe" placeholder="A–G"></div>
      <div class="col-2"><label>Année</label><input id="year" type="number"></div>

      <div class="col-2"><label>Chambres louables</label><input id="rooms" type="number"></div>
      <div class="col-2"><label>Loyer/chambre (€)</label><input id="rent_per_room" type="number"></div>
      <div class="col-2"><label>Loyer total mensuel (€)</label><input id="rent_total" type="number" placeholder="Auto: nb × loyer/ch."></div>

      <!-- Auto calculés via source -->
      <div class="col-3"><label>Charges mensuelles fixes (€) — auto</label><input id="fix_costs" type="number" disabled></div>
      <div class="col-3"><label>Taxe foncière annuelle (€) — auto</label><input id="tf_annual" type="number" disabled></div>
      <div class="col-3"><label>TEOM annuelle (€) — auto</label><input id="teom_annual" type="number" disabled></div>
      <div class="col-3"><label>Autres charges annuelles (€) — auto</label><input id="other_annual" type="number" disabled></div>
    </div>

    <div class="sep"></div>
    <h3>Financement</h3>
    <div class="grid">
      <div class="col-4"><label>Montant prêt banque (€)</label><input id="bank_amount" type="number"></div>
      <div class="col-4"><label>Taux banque (% annuel)</label><input id="bank_rate" type="number" step="0.01"></div>
      <div class="col-4"><label>Durée prêt banque (années)</label><input id="bank_years" type="number"></div>

      <div class="col-4"><label>Avance SASU (€)</label><input id="sasu_amount" type="number"></div>
      <div class="col-4"><label>Taux SASU (% annuel)</label><input id="sasu_rate" type="number" step="0.01"></div>
      <div class="col-4"><label>Durée SASU (années)</label><input id="sasu_years" type="number"></div>
    </div>

    <div style="margin-top:12px">
      <button class="btn accent" id="calcBtn">Recalculer</button>
      <button class="btn" id="saveBtn">Enregistrer</button>
    </div>
  </section>

  <!-- Fiscalité -->
  <section class="card" data-panel="fiscal" hidden>
    <h2>Régime fiscal & hypothèses</h2>
    <div class="grid">
      <div class="col-4">
        <label>Régime</label>
        <select id="tax_mode">
          <option value="LMP" selected>LMP (avec amortissements)</option>
          <option value="SIMPLE">Simplifié (cotis ~35% + IR barème)</option>
        </select>
      </div>
      <div class="col-4"><label>Parts fiscales (IR)</label><input id="nb_parts" type="number" step="0.5" value="1"></div>
      <div class="col-4"><label>Cotisations sociales (%)</label><input id="cot_rate" type="number" step="0.1" value="35"></div>

      <div class="col-4"><label>Gestion locative (% loyers) — auto</label><input id="mgmt_pct" type="number" disabled></div>
      <div class="col-4"><label>Provision CAPEX (% loyers) — auto</label><input id="capex_pct" type="number" disabled></div>
      <div class="col-4"><label>Occupation Phase 1 — auto</label><input id="occ_phase1" disabled></div>
      <div class="col-4"><label>Occupation Phase 2 — auto</label><input id="occ_phase2" disabled></div>
    </div>

    <div class="sep"></div>
    <h3>Hypothèses Amortissements (LMP)</h3>
    <p class="hint">N’affecte que le mode LMP.</p>
    <div class="grid">
      <div class="col-3"><label>% valeur bâtie (hors terrain)</label><input id="amort_bati_pct" type="number" step="1" value="85"></div>
      <div class="col-3"><label>Durée amort. bâti (ans)</label><input id="amort_bati_years" type="number" value="30"></div>
      <div class="col-3"><label>% mobilier</label><input id="amort_mob_pct" type="number" step="0.5" value="5"></div>
      <div class="col-3"><label>Durée amort. mobilier (ans)</label><input id="amort_mob_years" type="number" value="7"></div>
      <div class="col-3"><label>% frais de notaire</label><input id="amort_not_pct" type="number" step="0.5" value="2"></div>
      <div class="col-3"><label>Durée amort. notaire (ans)</label><input id="amort_not_years" type="number" value="5"></div>
    </div>
  </section>

  <!-- Résultats -->
  <section class="card" data-panel="result" hidden>
    <h2>Résultats</h2>
    <div class="kpi" id="kpiList"></div>
    <div class="sep"></div>
    <textarea id="debug" rows="16" class="mono" style="width:100%" readonly></textarea>
  </section>

  <!-- Sources -->
  <section class="card" data-panel="sources" hidden>
    <h2>Sources – Lien HTML direct (data.gouv) ou CSV/JSON</h2>
    <div class="grid">
      <div class="col-12">
        <label>URL de la source</label>
        <input id="api_url" value="https://www.data.gouv.fr/api/1/datasets/r/df7a9765-2ac9-45be-905f-d2bc5dc9fc35">
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn accent" id="btnLoadSource">Charger & Fusionner</button>
      <button class="btn" id="btnClearSources">Vider le cache des sources</button>
    </div>
    <div class="sep"></div>
    <h3>Journal (sources)</h3>
    <textarea id="sources_log" rows="10" class="mono" style="width:100%" readonly></textarea>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  /* ===== Utils ===== */
  function norm(s){return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9%€\/\.\- ]+/g,"").replace(/\s+/g," ").trim();}
  const $=s=>document.querySelector(s), $$=s=>[].slice.call(document.querySelectorAll(s));
  const fmtEur=v=>isNaN(v)?'—':v.toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  function pmt(r,n,p){ if(r===0) return -(p/n); return -(p*(r)*Math.pow(1+r,n))/(Math.pow(1+r,n)-1); }
  function getNum(sel){ const el=$(sel); const v=el?parseFloat(el.value):NaN; return isNaN(v)?0:v; }
  function getStr(sel){ const el=$(sel); return el?String(el.value).trim():""; }
  function saveState(){ const inputs=[].slice.call(document.querySelectorAll("input,select")).reduce((a,el)=>{a[el.id]=el.value;return a;},{}); localStorage.setItem("immo_state_full", JSON.stringify(inputs)); }
  function loadState(){ const raw=localStorage.getItem("immo_state_full"); if(!raw) return; const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=document.getElementById(k); if(el) el.value=d[k]; }); }
  function append(id,msg){ const el=$(id); if(!el) return; el.value+=(el.value?"\n":"")+msg; el.scrollTop=el.scrollHeight; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /* ===== Tabs ===== */
  $("#tabs").addEventListener("click", e=>{
    const b=e.target.closest(".tab-btn"); if(!b) return;
    $$(".tab-btn").forEach(x=>x.classList.remove("active")); b.classList.add("active");
    $$("[data-panel]").forEach(p=> p.hidden = (p.dataset.panel!==b.dataset.tab));
  });

  /* ===== Villes du classement ===== */
  const CITY_LIST = [
    {dep:"Val-de-Marne",dep_code:"94",city:"Joinville-le-Pont",transport:"RER A",mins:10,quality:9},
    {dep:"Val-de-Marne",dep_code:"94",city:"Nogent-sur-Marne",transport:"RER A",mins:14,quality:9},
    {dep:"Val-de-Marne",dep_code:"94",city:"Saint-Maur-des-Fossés",transport:"RER A",mins:12,quality:8.5},
    {dep:"Val-de-Marne",dep_code:"94",city:"Champigny-sur-Marne",transport:"RER A",mins:18,quality:7.5},
    {dep:"Hauts-de-Seine",dep_code:"92",city:"Sceaux",transport:"RER B",mins:10,quality:9},
    {dep:"Hauts-de-Seine",dep_code:"92",city:"Bourg-la-Reine",transport:"RER B",mins:10,quality:9},
    {dep:"Hauts-de-Seine",dep_code:"92",city:"Antony",transport:"RER B",mins:12,quality:8.5},
    {dep:"Hauts-de-Seine",dep_code:"92",city:"Fontenay-aux-Roses",transport:"RER B",mins:14,quality:8},
    {dep:"Yvelines",dep_code:"78",city:"Saint-Germain-en-Laye",transport:"RER A",mins:10,quality:9.5},
    {dep:"Yvelines",dep_code:"78",city:"Le Vésinet",transport:"RER A",mins:14,quality:9.5},
    {dep:"Yvelines",dep_code:"78",city:"Houilles-Carrières-sur-Seine",transport:"RER A/J",mins:8,quality:9},
    {dep:"Yvelines",dep_code:"78",city:"Maisons-Laffitte",transport:"RER A/J",mins:15,quality:9},
    {dep:"Yvelines",dep_code:"78",city:"Chatou",transport:"RER A",mins:12,quality:8.5},
    {dep:"Yvelines",dep_code:"78",city:"Croissy-sur-Seine",transport:"RER A",mins:16,quality:8.5},
    {dep:"Yvelines",dep_code:"78",city:"Achères",transport:"RER A/J",mins:18,quality:7.5},
    {dep:"Yvelines",dep_code:"78",city:"Conflans-Sainte-Honorine",transport:"RER A/J",mins:20,quality:7.5},
    {dep:"Yvelines",dep_code:"78",city:"Saint-Rémy-lès-Chevreuse",transport:"RER B",mins:18,quality:8},
    {dep:"Yvelines",dep_code:"78",city:"Saint-Cyr-l’École",transport:"RER C",mins:15,quality:7.5},
    {dep:"Yvelines",dep_code:"78",city:"Viroflay",transport:"RER C",mins:15,quality:8},
    {dep:"Yvelines",dep_code:"78",city:"Versailles",transport:"RER C",mins:20,quality:9},
    {dep:"Yvelines",dep_code:"78",city:"Marly-le-Roi",transport:"Transilien L",mins:15,quality:8.5},
    {dep:"Yvelines",dep_code:"78",city:"Saint-Nom-la-Bretèche",transport:"Transilien L",mins:18,quality:9},
    {dep:"Yvelines",dep_code:"78",city:"Plaisir-Grignon",transport:"Transilien N",mins:15,quality:7},
    {dep:"Yvelines",dep_code:"78",city:"Beynes",transport:"Transilien N",mins:18,quality:7},
    {dep:"Yvelines",dep_code:"78",city:"Les Mureaux",transport:"Transilien J",mins:15,quality:6},
    {dep:"Yvelines",dep_code:"78",city:"Vernouillet-Verneuil",transport:"Transilien J",mins:18,quality:6.5},
    {dep:"Yvelines",dep_code:"78",city:"Meulan-en-Yvelines",transport:"Transilien J",mins:20,quality:6.5},
    {dep:"Yvelines",dep_code:"78",city:"Mantes-la-Jolie",transport:"Transilien J",mins:18,quality:6},
    {dep:"Yvelines",dep_code:"78",city:"Épône-Mézières",transport:"Transilien J",mins:17,quality:6.5},
    {dep:"Yvelines",dep_code:"78",city:"Aubergenville",transport:"Transilien J",mins:15,quality:6.5},
    {dep:"Essonne",dep_code:"91",city:"Massy",transport:"RER B/C/TGV",mins:15,quality:8},
    {dep:"Essonne",dep_code:"91",city:"Palaiseau",transport:"RER B",mins:15,quality:8.5},
    {dep:"Essonne",dep_code:"91",city:"Gif-sur-Yvette",transport:"RER B",mins:17,quality:8},
    {dep:"Essonne",dep_code:"91",city:"Orsay",transport:"RER B",mins:15,quality:8.5},
    {dep:"Essonne",dep_code:"91",city:"Juvisy-sur-Orge",transport:"RER C/D",mins:10,quality:7.5},
    {dep:"Essonne",dep_code:"91",city:"Savigny-sur-Orge",transport:"RER C",mins:12,quality:7.5},
    {dep:"Essonne",dep_code:"91",city:"Épinay-sur-Orge",transport:"RER C",mins:12,quality:7.5},
    {dep:"Essonne",dep_code:"91",city:"Sainte-Geneviève-des-Bois",transport:"RER C",mins:15,quality:7},
    {dep:"Essonne",dep_code:"91",city:"Longjumeau",transport:"RER C",mins:16,quality:7},
    {dep:"Essonne",dep_code:"91",city:"Brétigny-sur-Orge",transport:"RER C",mins:20,quality:6.5},
    {dep:"Essonne",dep_code:"91",city:"Évry-Courcouronnes",transport:"RER D",mins:15,quality:6.5},
    {dep:"Essonne",dep_code:"91",city:"Ris-Orangis",transport:"RER D",mins:12,quality:7},
    {dep:"Essonne",dep_code:"91",city:"Corbeil-Essonnes",transport:"RER D",mins:15,quality:6.5},
    {dep:"Essonne",dep_code:"91",city:"Mennecy",transport:"RER D",mins:18,quality:6.5},
    {dep:"Val-d’Oise",dep_code:"95",city:"Cergy-Préfecture",transport:"RER A/J",mins:12,quality:7.5}
  ];

  /* Fallback CP/INSEE local (si l'API est KO) — un CP principal par ville */
  const CP_INSEE_FALLBACK = {
    "Joinville-le-Pont":"94340","Nogent-sur-Marne":"94130","Saint-Maur-des-Fossés":"94100",
    "Champigny-sur-Marne":"94500","Sceaux":"92330","Bourg-la-Reine":"92340","Antony":"92160",
    "Fontenay-aux-Roses":"92260","Saint-Germain-en-Laye":"78100","Le Vésinet":"78110",
    "Houilles-Carrières-sur-Seine":"78800","Maisons-Laffitte":"78600","Chatou":"78400","Croissy-sur-Seine":"78290",
    "Achères":"78260","Conflans-Sainte-Honorine":"78700","Saint-Rémy-lès-Chevreuse":"78470",
    "Saint-Cyr-l’École":"78210","Viroflay":"78220","Versailles":"78000","Marly-le-Roi":"78160",
    "Saint-Nom-la-Bretèche":"78860","Plaisir-Grignon":"78370","Beynes":"78650","Les Mureaux":"78130",
    "Vernouillet-Verneuil":"78540","Meulan-en-Yvelines":"78250","Mantes-la-Jolie":"78200",
    "Épône-Mézières":"78680","Aubergenville":"78410","Massy":"91300","Palaiseau":"91120",
    "Gif-sur-Yvette":"91190","Orsay":"91400","Juvisy-sur-Orge":"91260","Savigny-sur-Orge":"91600",
    "Épinay-sur-Orge":"91360","Sainte-Geneviève-des-Bois":"91700","Longjumeau":"91160",
    "Brétigny-sur-Orge":"91220","Évry-Courcouronnes":"91000","Ris-Orangis":"91130",
    "Corbeil-Essonnes":"91100","Mennecy":"91540","Cergy-Préfecture":"95000"
  };

  function populateCitySelect(){
    const sel=$("#city"); sel.innerHTML="";
    const def=document.createElement("option"); def.value=""; def.textContent="— Sélectionner —"; sel.appendChild(def);
    CITY_LIST.forEach(o=>{ const op=document.createElement("option"); op.value=o.city; op.textContent=`${o.city} (${o.dep_code})`; op.dataset.dep=o.dep_code; op.dataset.info=JSON.stringify(o); sel.appendChild(op); });
    const other=document.createElement("option"); other.value="__other"; other.textContent="Autre ville (saisie manuelle)"; sel.appendChild(other);
  }
  function qualityToOcc(q){ if(q>=9) return ["1.00","1.00"]; if(q>=8) return ["0.90","1.00"]; if(q>=7) return ["0.80","0.90"]; if(q>=6) return ["0.70","0.80"]; return ["0.50","0.70"]; }

  /* ===== API GEO.GOUV: CP + INSEE ===== */
  async function fetchCommune(city, depCode){
    const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(city)}${depCode?`&codeDepartement=${encodeURIComponent(depCode)}`:""}&fields=codesPostaux,code,nom&boost=population&limit=10`;
    const res = await fetch(url, {mode:"cors"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.json();
  }
  function fillCpList(codes){
    const dl=$("#cp_options"); dl.innerHTML="";
    (codes||[]).forEach(cp=>{ const opt=document.createElement("option"); opt.value=cp; dl.appendChild(opt); });
  }
  async function setCpInseeFromCity(city, depCode){
    const cpInput=$("#cp"), insee=$("#insee");
    try{
      const data = await fetchCommune(city, depCode);
      if(!data || !data.length){ throw new Error("Commune introuvable"); }
      // On prend la meilleure correspondance (1ère)
      const best = data[0];
      const cpList = best.codesPostaux && best.codesPostaux.length ? best.codesPostaux : [];
      fillCpList(cpList);
      if(cpList.length && (!cpInput.value || !cpList.includes(cpInput.value))){
        cpInput.value = cpList[0];
      }
      insee.value = best.code || "";
    }catch(e){
      // Fallback local : un seul CP + INSEE vide
      const fallbackCP = CP_INSEE_FALLBACK[city];
      fillCpList(fallbackCP?[fallbackCP]:[]);
      if(fallbackCP) cpInput.value = fallbackCP;
      if(!insee.value) insee.value = "";
    }
  }
  async function setInseeFromCityAndCp(city, depCode, cp){
    // tente de verrouiller l'INSEE en croisant nom + CP
    try{
      const data = await fetchCommune(city, depCode);
      if(!data || !data.length) return;
      const match = data.find(c => (c.codesPostaux||[]).includes(cp)) || data[0];
      $("#insee").value = match.code || $("#insee").value;
    }catch(_e){}
  }

  async function onCityChange(){
    const sel=$("#city"), info=$("#city_info"); const v=sel.value;
    if(!v){ info.textContent=""; return; }
    if(v==="__other"){ info.innerHTML="Saisissez la ville manuellement via l’adresse/CP."; return; }
    const op=sel.options[sel.selectedIndex];
    const o = op && op.dataset.info ? JSON.parse(op.dataset.info) : null;
    if(o){
      info.innerHTML=`<span class="badge">${o.dep} (${o.dep_code})</span><span class="badge">${o.transport}</span><span class="badge">${o.mins} min</span><span class="badge">Qualité ${o.quality}/10</span>`;
      // Fallback occupation
      if(!$("#occ_phase1").value || !$("#occ_phase2").value){
        const [a,b]=qualityToOcc(o.quality); $("#occ_phase1").value=a; $("#occ_phase2").value=b;
      }
      await setCpInseeFromCity(o.city, o.dep_code);
    }
  }
  let cpTypingTimer=null;
  $("#cp").addEventListener("input", ()=>{
    if(cpTypingTimer) clearTimeout(cpTypingTimer);
    cpTypingTimer=setTimeout(async ()=>{
      const sel=$("#city"); const v=sel.value; if(!v || v==="__other") return;
      const dep = sel.options[sel.selectedIndex].dataset.dep;
      await setInseeFromCityAndCp(v, dep, $("#cp").value.trim());
    }, 350);
  });

  /* ===== Référentiel source (fusion) ===== */
  let REF_ROWS = [];
  const CP_KEYS = ["cp","code postal","code_postal","postal code","code insee","insee","codgeo","codgeo commune"];
  const CITY_KEYS = ["ville","commune","city","nom_commune","nom","libelle","libellé"];
  const COL_HINTS = {
    tf_m2:["taxe fonciere €/m2","tf €/m2","tf m2","taxe fonciere m2","taxe_fonciere_m2","taxe_fonciere_eur_m2","tf_eur_m2","taxe fonciere (€ / m2)"],
    teom_m2:["teom €/m2","teom m2","teom_eur_m2","teom (€ / m2)"],
    teom_an:["teom annuelle (€)","teom €/an","teom an","teom","teom_eur_an"],
    charges_fixes_m:["charges fixes €/mois","charges mensuelles fixes (€)","charges fixes mensuelles","charges_fixes_mensuelles","charges fixes (eur/mois)","charges_fixes_eur_mois","fix costs"],
    gestion_pct:["gestion locative (% loyers)","gestion locative %","frais agence %","property management %","mgmt %","gestion_locative_pourcent","gestion % loyers","gestion (%)"],
    capex_pct:["provision capex (% loyers)","capex %","provision gros travaux %","capex_pourcent","provision capex (%)"],
    tension:["tension locative","dossiers/chambre","tension locative (dossiers/ch)","tension","dossiers_par_chambre"]
  };
  function getColIndex(headers, candidates){ const H=headers.map(norm); for(const cand of candidates){ const c=norm(cand); let i=H.indexOf(c); if(i>=0) return i; i=H.findIndex(h=>h.includes(c)); if(i>=0) return i; } return -1; }
  function pickNumberFromRow(row,candidates){ const keys=Object.keys(row); const idx=getColIndex(keys,candidates); if(idx<0) return null; const key=keys[idx]; const val=row[key]; const num=parseFloat(String(val).replace(',','.')); return isNaN(num)?null:num; }
  function normalizeRow(row){ const out={}; for(const k in row){ if(Object.prototype.hasOwnProperty.call(row,k)) { out[k]=row[k]; out["__"+norm(k)]=row[k]; } } return out; }
  function mergeIntoReferential(rows){ for(const r of rows){ REF_ROWS.push(normalizeRow(r)); } }
  function findRefRowFor(city,cp){
    if(!REF_ROWS.length) return null;
    const cityN=norm(city), cpN=norm(cp);
    for(const r of REF_ROWS){ for(const k of Object.keys(r)){ if(CP_KEYS.map(norm).includes(norm(k))){ if(norm(String(r[k]||""))===cpN) return r; } } }
    for(const r2 of REF_ROWS){ for(const k2 of Object.keys(r2)){ if(CITY_KEYS.map(norm).includes(norm(k2))){ if(norm(String(r2[k2]||""))===cityN) return r2; } } }
    return null;
  }

  /* ===== CAPEX (DPE×Âge) ===== */
  function capexPctFromDPEandAge(dpe, year){
    const y = parseInt(year||0,10);
    const age = (y>0) ? Math.max(0, new Date().getFullYear()-y) : 40;
    const d = String(dpe||"D").toUpperCase();
    const bucket = (age<=10)?"0_10":(age<=30)?"11_30":(age<=60)?"31_60":"61p";
    const T = {
      "A":{"0_10":3,"11_30":4,"31_60":5,"61p":6},"B":{"0_10":3.5,"11_30":5,"31_60":6,"61p":7.5},
      "C":{"0_10":4,"11_30":6,"31_60":8,"61p":10},"D":{"0_10":5,"11_30":7.5,"31_60":10,"61p":12},
      "E":{"0_10":6,"11_30":9,"31_60":12,"61p":15},"F":{"0_10":7,"11_30":11,"31_60":14,"61p":18},
      "G":{"0_10":8,"11_30":13,"31_60":17,"61p":22}
    };
    return (T[d]||T["D"])[bucket];
  }

  /* ===== Auto calculs via référentiel ===== */
  function autoFromReferential(){
    const city=$("#city").value, cp=$("#cp").value, surf=getNum("#surf"), year=getNum("#year"), dpe=getStr("#dpe");
    if(!city || city==="__other"){ append("#debug","[Auto] Ville vide ou manuelle."); return; }
    const row=findRefRowFor(city,cp);

    const tf_m2= row ? pickNumberFromRow(row,COL_HINTS.tf_m2) : null;
    const teom_m2= row ? pickNumberFromRow(row,COL_HINTS.teom_m2) : null;
    const teom_an= row ? pickNumberFromRow(row,COL_HINTS.teom_an) : null;
    const fix_m= row ? pickNumberFromRow(row,COL_HINTS.charges_fixes_m) : null;
    const gest= row ? pickNumberFromRow(row,COL_HINTS.gestion_pct) : null;
    const capex= row ? pickNumberFromRow(row,COL_HINTS.capex_pct) : null;
    const tension= row ? pickNumberFromRow(row,COL_HINTS.tension) : null;

    if(tf_m2!=null && surf>0) $("#tf_annual").value = Math.round(tf_m2*surf);
    if(teom_m2!=null && surf>0) $("#teom_annual").value = Math.round(teom_m2*surf);
    if(teom_an!=null) $("#teom_annual").value = Math.round(teom_an);
    if(fix_m!=null) $("#fix_costs").value = Math.round(fix_m);

    $("#mgmt_pct").value = (gest!=null? gest.toFixed(2) : "7.00");
    $("#capex_pct").value = (capex!=null? capex.toFixed(2) : capexPctFromDPEandAge(dpe,year).toFixed(2));

    // Occupation depuis "tension" sinon fallback qualité
    let occ1=$("#occ_phase1").value||"0.90", occ2=$("#occ_phase2").value||"1.00";
    if(tension!=null){
      if(tension>=5){ occ1="1.00"; occ2="1.00"; }
      else if(tension>=3){ occ1="0.90"; occ2="1.00"; }
      else if(tension>=2){ occ1="0.80"; occ2="0.90"; }
      else if(tension>=1){ occ1="0.70"; occ2="0.80"; }
      else { occ1="0.50"; occ2="0.70"; }
    } else {
      const found = CITY_LIST.find(o=> o.city.toLowerCase()===String(city).toLowerCase());
      if(found){ const q=found.quality; const m= (q>=9)?["1.00","1.00"]:(q>=8)?["0.90","1.00"]:(q>=7)?["0.80","0.90"]:(q>=6)?["0.70","0.80"]:["0.50","0.70"]; occ1=m[0]; occ2=m[1]; }
    }
    $("#occ_phase1").value=occ1; $("#occ_phase2").value=occ2;

    const rent = getNum("#rent_total") || (getNum("#rooms")*getNum("#rent_per_room"));
    if(!getNum("#other_annual") && rent){ $("#other_annual").value = Math.round(rent*12*0.05); }
    saveState();
  }

  /* ===== IR 2025 ===== */
  const IR2025_THRESHOLDS = [
    { upTo: 11497, rate: 0.00 },
    { upTo: 29315, rate: 0.11 },
    { upTo: 83823, rate: 0.30 },
    { upTo: 180294, rate: 0.41 },
    { upTo: Infinity, rate: 0.45 }
  ];
  function frenchIR2025(baseImposableAnnuel, parts){
    parts = Math.max(1, parts||1);
    const qp = baseImposableAnnuel / parts;
    let impPart = 0, prev = 0;
    for(const tr of IR2025_THRESHOLDS){
      const width = Math.max(0, Math.min(qp, tr.upTo) - prev);
      if(width>0) impPart += width * tr.rate;
      if(qp <= tr.upTo) break;
      prev = tr.upTo;
    }
    return impPart * parts;
  }

  /* ===== KPIs & calculs ===== */
  const KPI_LIST = [
    ["mode_fiscal","Mode fiscal actif"],
    ["revenus_brut_m","Revenus bruts mensuels"],
    ["revenus_brut_a","Revenus bruts annuels"],
    ["mensualite_banque","Mensualité banque (PMT)"],
    ["mensualite_sasu","Mensualité SASU (PMT)"],
    ["charges_mensuelles","Charges mensuelles (fixes+gestion+CAPEX+TEOM+autres/12)"],
    ["coupon_phase1","Coupon investisseur (phase 1) – intérêts SASU (mensuel)"],
    ["charges_tf_mois","Taxe foncière (mois)"],
    ["impots_cotisations_ann","Cotisations + IR (annuel)"],
    ["resultat_fiscal_lmp","Résultat fiscal LMP (annuel)"],
    ["caf_apres_impots_a","CAF après impôts (annuel)"],
    ["caf_apres_impots_m","CAF après impôts (mensuel)"],
    ["cashflow_m_ph1_occ1","Cash-flow net mensuel – Phase 1 (occ. auto)"],
    ["cashflow_a_ph2_occ1","Cash-flow net annuel – Phase 2 (occ. auto)"],
    ["cashflow_m_ph1_occ05","Cash-flow net mensuel – Phase 1 (occ. 50%)"],
    ["cashflow_a_ph2_occ05","Cash-flow net annuel – Phase 2 (occ. 50%)"]
  ];
  function renderKPIs(obj){
    const root=$("#kpiList"); root.innerHTML="";
    const money=new Set(KPI_LIST.map(k=>k[0]).filter(k=>k!=="mode_fiscal"));
    for(const [key,label] of KPI_LIST){
      const v=obj[key];
      const isMoney=money.has(key);
      const sign=(typeof v==="number" && (key.includes("cashflow")||key.includes("mensualite")||key.includes("charges")||key.includes("coupon")||key.includes("resultat")||key.includes("caf")))?(v>=0?"pos":"neg"):"";
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML=`<h3>${label}</h3><div class="val ${sign}">${(v==null||v===undefined)?"—":(isMoney?fmtEur(v):v)}</div>`;
      root.appendChild(el);
    }
  }

  function computeResults(){
    const bankAmount=getNum("#bank_amount"), bankRate=getNum("#bank_rate")/100, bankYears=getNum("#bank_years");
    const sasuAmount=getNum("#sasu_amount"), sasuRate=getNum("#sasu_rate")/100, sasuYears=getNum("#sasu_years");
    const rooms=getNum("#rooms"), rpr=getNum("#rent_per_room"); let rentTotal=getNum("#rent_total"); if(!rentTotal && rooms && rpr){ rentTotal=rooms*rpr; $("#rent_total").value=rentTotal; }
    const occ1=parseFloat($("#occ_phase1").value||"1"), occ2=parseFloat($("#occ_phase2").value||"1");
    const fixCosts=getNum("#fix_costs"), tfAnnual=getNum("#tf_annual"), teomAnnual=getNum("#teom_annual"), otherAnnual=getNum("#other_annual");
    const mgmtPct=getNum("#mgmt_pct")/100, capexPct=getNum("#capex_pct")/100;
    const mode = getStr("#tax_mode") || "LMP";
    const NB_PARTS = Math.max(1, getNum("#nb_parts")||1);
    const COT_RATE = Math.max(0, getNum("#cot_rate")||35)/100;

    const bankM=pmt(bankRate/12, bankYears*12, bankAmount);
    const sasuM=pmt(sasuRate/12, sasuYears*12, sasuAmount);
    const mensualiteBanque=-bankM, mensualiteSASU=-sasuM;

    const interetsBanque = Math.max(0, bankAmount * bankRate);
    const interetsSASU   = Math.max(0, sasuAmount * sasuRate);

    const RSASU_an = interetsSASU;
    const rentTotalM = rentTotal;
    const loyersA=rentTotalM*12;
    const gestionA=rentTotalM*mgmtPct*12, capexA=rentTotalM*capexPct*12;
    const chargesA=(fixCosts*12)+tfAnnual+teomAnnual+otherAnnual+gestionA+capexA;

    // Fiscalité
    let baseImp, cotSoc, IR, baseIR, impLabel=mode;
    let resultatFiscalLMP=null, amortTotal=0;

    if(mode==="LMP"){
      const price=getNum("#price");
      const amortBat=(price*(getNum("#amort_bati_pct")/100))/Math.max(1,getNum("#amort_bati_years"));
      const amortMob=(price*(getNum("#amort_mob_pct")/100))/Math.max(1,getNum("#amort_mob_years"));
      const amortNot=(price*(getNum("#amort_not_pct")/100))/Math.max(1,getNum("#amort_not_years"));
      amortTotal=amortBat+amortMob+amortNot;

      resultatFiscalLMP = loyersA - chargesA - amortTotal - interetsBanque - interetsSASU;

      baseImp = Math.max(0, resultatFiscalLMP);
      cotSoc = baseImp * COT_RATE;
      baseIR = Math.max(0, baseImp - cotSoc);
      IR = frenchIR2025(baseIR, NB_PARTS);
      impLabel = `LMP (amort: ${Math.round(amortTotal).toLocaleString('fr-FR')} €/an)`;
    } else {
      baseImp = Math.max(0, loyersA - chargesA);
      cotSoc = baseImp * COT_RATE;
      baseIR = Math.max(0, baseImp - cotSoc);
      IR = frenchIR2025(baseIR, NB_PARTS);
      impLabel = "Simplifié";
    }
    const impCotAn = cotSoc + IR;

    // CAF (après impôts, avant dette)
    const cafA = loyersA - chargesA - impCotAn;
    const cafM = cafA/12;

    function net(occ,phase){
      const lOcc=loyersA*occ;
      const sasu = (phase===1)? RSASU_an : (mensualiteSASU*12);
      return lOcc - chargesA - (mensualiteBanque*12) - sasu - impCotAn;
    }

    const res={
      mode_fiscal:impLabel,
      revenus_brut_m:rentTotalM,
      revenus_brut_a:loyersA,
      mensualite_banque:mensualiteBanque,
      mensualite_sasu:mensualiteSASU,
      charges_mensuelles:(chargesA/12),
      coupon_phase1:RSASU_an/12,
      charges_tf_mois:(tfAnnual/12),
      impots_cotisations_ann:impCotAn,
      resultat_fiscal_lmp:(mode==="LMP"?resultatFiscalLMP:null),
      caf_apres_impots_a:cafA,
      caf_apres_impots_m:cafM,
      cashflow_m_ph1_occ1:net(occ1,1)/12,
      cashflow_a_ph2_occ1:net(occ2,2),
      cashflow_m_ph1_occ05:net(0.5,1)/12,
      cashflow_a_ph2_occ05:net(0.5,2)
    };
    const dbg={mode,NB_PARTS,COT_RATE,loyersA,gestionA,capexA,chargesA,interetsBanque,interetsSASU,amortTotal,resultatFiscalLMP,baseImp,baseIR,IR,cotSoc,cafA,cafM,ref:`REF: ${REF_ROWS.length} lignes`};
    return {res,dbg};
  }

  /* ===== Loader source data.gouv (HTML / CSV / JSON) ===== */
  function looksLikeJSON(t){ t=String(t||"").trim(); return t[0]==="{"||t[0]==="["; }
  function isHTML(t){ const s=String(t||"").trim().slice(0,200).toLowerCase(); return s.includes("<!doctype html")||s.includes("<html"); }
  function parseHTMLTablesToRows(htmlText){
    const parser=new DOMParser(); const doc=parser.parseFromString(htmlText,"text/html");
    const rows=[]; [].slice.call(doc.querySelectorAll("table")).forEach(tbl=>{
      const trs=[].slice.call(tbl.querySelectorAll("tr")); if(!trs.length) return;
      const ths=trs[0].querySelectorAll("th,td");
      if(ths.length>=2){
        const headers=[].slice.call(ths).map(th=>th.textContent.trim());
        for(let i=1;i<trs.length;i++){ const cells=[].slice.call(trs[i].querySelectorAll("td,th")); if(!cells.length) continue;
          const obj={}; cells.forEach((c,idx)=>{ obj[headers[idx]||("col_"+idx)]=c.textContent.trim(); }); rows.push(obj); }
      } else {
        trs.forEach(tr=>{ const cells=[].slice.call(tr.querySelectorAll("td,th")); if(!cells.length) return; const obj={}; cells.forEach((c,idx)=>{ obj["col_"+idx]=c.textContent.trim(); }); rows.push(obj); });
      }
    });
    return rows;
  }
  async function fetchAsText(url){ const res=await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error("HTTP "+res.status); return await res.text(); }

  $("#btnLoadSource").addEventListener("click", async ()=>{
    const url=getStr("#api_url"); if(!url){ alert("URL requise."); return; }
    try{
      append("#sources_log","Chargement: "+url);
      const text=await fetchAsText(url); let rows=[];
      if(isHTML(text)){ rows=parseHTMLTablesToRows(text); append("#sources_log",`→ HTML détecté: ${rows.length} lignes`); }
      else if(looksLikeJSON(text)){ const json=JSON.parse(text); rows=Array.isArray(json)?json:(Array.isArray(json.items)?json.items:[]); append("#sources_log",`→ JSON: ${rows.length}`); }
      else { const parsed=Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true}); rows=parsed.data; append("#sources_log",`→ CSV: ${rows.length}`); }
      mergeIntoReferential(rows); append("#sources_log",`Fusion totale: ${REF_ROWS.length} lignes`);
      autoFromReferential(); const out=computeResults(); renderKPIs(out.res); $("#debug").value=JSON.stringify(out.dbg,null,2);
    }catch(err){ append("#sources_log","❌ "+(err&&err.message?err.message:err)); }
  });
  $("#btnClearSources").addEventListener("click",()=>{ localStorage.removeItem("immo_state_full"); REF_ROWS=[]; append("#sources_log","Cache vidé et référentiel réinitialisé."); });

  // Préchargement data.gouv (HTML)
  (async function preload(){
    const url="https://www.data.gouv.fr/api/1/datasets/r/df7a9765-2ac9-45be-905f-d2bc5dc9fc35";
    try{
      const t=await fetchAsText(url); let rows=[];
      if(isHTML(t)){ rows=parseHTMLTablesToRows(t); append("#sources_log",`Préchargé (HTML): ${rows.length} lignes`); }
      else if(looksLikeJSON(t)){ const j=JSON.parse(t); rows=Array.isArray(j)?j:(Array.isArray(j.items)?j.items:[]); append("#sources_log",`Préchargé (JSON): ${rows.length}`); }
      else { const p=Papa.parse(t,{header:true,dynamicTyping:true,skipEmptyLines:true}); rows=p.data; append("#sources_log",`Préchargé (CSV): ${p.data.length} lignes`); }
      mergeIntoReferential(rows);
    }catch(e){ append("#sources_log","Préchargement KO: "+e.message); }
  })();

  /* ===== Actions ===== */
  $("#city").addEventListener("change", onCityChange);
  $("#calcBtn").addEventListener("click", ()=>{ autoFromReferential(); const out=computeResults(); renderKPIs(out.res); $("#debug").value=JSON.stringify(out.dbg,null,2); });
  $("#saveBtn").addEventListener("click", ()=>{ saveState(); alert("Données sauvegardées (local)"); });
  $("#resetBtn").addEventListener("click", ()=>{ localStorage.removeItem("immo_state_full"); location.reload(); });
  $$(".card input, .card select").forEach(el=> el.addEventListener("change", saveState));

  /* ===== Init ===== */
  populateCitySelect();
  loadState();
  if($("#city").value) onCityChange();
  const dbg=$("#debug");
  if(dbg) dbg.value="1) Choisis une ville • 2) Le CP/INSEE se remplissent (API geo.api.gouv.fr) • 3) Recalculer. Si l’API échoue, on bascule sur un CP local par défaut.";
});
</script>
</body>
</html>
