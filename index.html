<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Invest_IMMO • LMP / Simplifié + HTML data.gouv + IR 2025 + CAPEX</title>
<!-- Lib -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
<style>
:root{--bg:#0f1222;--fg:#f3f5ff;--muted:#aeb3d0;--card:#171a2e;--line:#252947;--accent:#6ea8fe;--accent2:#9c6efe;--ok:#3ddc84;--bad:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{padding:18px 22px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
header h1{margin:0;font-size:18px}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px 40px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.tab-btn{padding:10px 14px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:10px;cursor:pointer}
.tab-btn.active{outline:2px solid var(--accent)}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
label{display:block;margin:0 0 6px;color:var(--muted);font-size:13px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);background:#111428;color:var(--fg);border-radius:8px}
input[disabled]{opacity:.7}
.btn{padding:10px 14px;border:1px solid var(--line);background:#111428;color:#fff;border-radius:10px;cursor:pointer}
.btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
.kpi{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.kpi .item{grid-column:span 6;background:#111428;border:1px solid var(--line);border-radius:12px;padding:14px}
.kpi h3{margin:0 0 6px;font-size:14px;color:var(--muted)}
.val{font-size:20px;font-weight:700}
.pos{color:var(--ok)}.neg{color:var(--bad)}
.mono{font-family:ui-monospace,monospace;font-size:12px}
.sep{height:1px;background:var(--line);margin:16px 0}
.hint{color:var(--muted);font-size:12px}
@media(max-width:900px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}.kpi .item{grid-column:span 12}}
</style>
</head>
<body>
<header>
  <h1>Invest_IMMO • Mode fiscal LMP / Simplifié</h1>
  <span class="pill">HTML data.gouv + IR 2025 + CAPEX</span>
  <button class="btn" id="resetBtn">Réinitialiser</button>
</header>

<div class="wrap">
  <nav class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="saisie">Saisie</button>
    <button class="tab-btn" data-tab="fiscal">Fiscalité</button>
    <button class="tab-btn" data-tab="param">Paramètres (auto)</button>
    <button class="tab-btn" data-tab="result">Résultats</button>
    <button class="tab-btn" data-tab="sources">Sources (HTML / CSV / JSON)</button>
  </nav>

  <!-- Saisie -->
  <section class="card" data-panel="saisie">
    <h2>Saisie du bien</h2>
    <div class="grid">
      <div class="col-4"><label>Ville</label><input id="city" placeholder="Joinville-le-Pont"></div>
      <div class="col-4"><label>Code postal</label><input id="cp" placeholder="94340"></div>
      <div class="col-4"><label>Adresse</label><input id="address" placeholder="3 rue Exemple"></div>

      <div class="col-3"><label>Prix d’achat FAI (€)</label><input id="price" type="number"></div>
      <div class="col-3"><label>Surface (m²)</label><input id="surf" type="number"></div>
      <div class="col-3"><label>DPE</label><input id="dpe" placeholder="A–G"></div>
      <div class="col-3"><label>Année</label><input id="year" type="number"></div>

      <div class="col-3"><label>Chambres louables</label><input id="rooms" type="number"></div>
      <div class="col-3"><label>Loyer/chambre (€)</label><input id="rent_per_room" type="number"></div>
      <div class="col-3"><label>Loyer total mensuel (€)</label><input id="rent_total" type="number" placeholder="Auto: nb × loyer/ch."></div>

      <!-- Auto -->
      <div class="col-3"><label>Charges mensuelles fixes (€) — auto</label><input id="fix_costs" type="number" disabled></div>
      <div class="col-3"><label>Taxe foncière annuelle (€) — auto</label><input id="tf_annual" type="number" disabled></div>
      <div class="col-3"><label>TEOM annuelle (€) — auto</label><input id="teom_annual" type="number" disabled></div>
      <div class="col-3"><label>Autres charges annuelles (€) — auto</label><input id="other_annual" type="number" disabled></div>
    </div>

    <div class="sep"></div>
    <h3>Financement</h3>
    <div class="grid">
      <div class="col-4"><label>Montant prêt banque (€)</label><input id="bank_amount" type="number"></div>
      <div class="col-4"><label>Taux banque (% annuel)</label><input id="bank_rate" type="number" step="0.01"></div>
      <div class="col-4"><label>Durée prêt banque (années)</label><input id="bank_years" type="number"></div>

      <div class="col-4"><label>Avance SASU (€)</label><input id="sasu_amount" type="number"></div>
      <div class="col-4"><label>Taux SASU (% annuel)</label><input id="sasu_rate" type="number" step="0.01"></div>
      <div class="col-4"><label>Durée SASU (années)</label><input id="sasu_years" type="number"></div>
    </div>

    <div style="margin-top:12px">
      <button class="btn accent" id="calcBtn">Recalculer</button>
      <button class="btn" id="saveBtn">Enregistrer</button>
    </div>
  </section>

  <!-- Fiscalité -->
  <section class="card" data-panel="fiscal" hidden>
    <h2>Régime fiscal & hypothèses</h2>
    <div class="grid">
      <div class="col-4">
        <label>Régime</label>
        <select id="tax_mode">
          <option value="LMP" selected>LMP (avec amortissements)</option>
          <option value="SIMPLE">Simplifié (cotis ~35% + IR barème)</option>
        </select>
      </div>
      <div class="col-4"><label>Parts fiscales (IR)</label><input id="nb_parts" type="number" step="0.5" value="1"></div>
      <div class="col-4"><label>Cotisations sociales (%)</label><input id="cot_rate" type="number" step="0.1" value="35"></div>

      <div class="col-4"><label>Gestion locative (% loyers) — auto</label><input id="mgmt_pct" type="number" disabled></div>
      <div class="col-4"><label>Provision CAPEX (% loyers) — auto</label><input id="capex_pct" type="number" disabled></div>
      <div class="col-4"><label>Occupation Phase 1 — auto</label><input id="occ_phase1" disabled></div>
      <div class="col-4"><label>Occupation Phase 2 — auto</label><input id="occ_phase2" disabled></div>
    </div>

    <div class="sep"></div>
    <h3>Hypothèses Amortissements (LMP)</h3>
    <p class="hint">Ces hypothèses n’affectent que le mode LMP. Ajuste si besoin.</p>
    <div class="grid">
      <div class="col-3"><label>% valeur bâtie (hors terrain)</label><input id="amort_bati_pct" type="number" step="1" value="85"></div>
      <div class="col-3"><label>Durée amort. bâti (ans)</label><input id="amort_bati_years" type="number" value="30"></div>
      <div class="col-3"><label>% mobilier</label><input id="amort_mob_pct" type="number" step="0.5" value="5"></div>
      <div class="col-3"><label>Durée amort. mobilier (ans)</label><input id="amort_mob_years" type="number" value="7"></div>
      <div class="col-3"><label>% frais de notaire</label><input id="amort_not_pct" type="number" step="0.5" value="2"></div>
      <div class="col-3"><label>Durée amort. notaire (ans)</label><input id="amort_not_years" type="number" value="5"></div>
    </div>
  </section>

  <!-- Paramètres auto -->
  <section class="card" data-panel="param" hidden>
    <h2>Paramètres financiers (calculés)</h2>
    <p class="hint">Issus des règles/jeux de données fusionnés (Ville/CP, DPE, année, tension).</p>
  </section>

  <!-- Résultats -->
  <section class="card" data-panel="result" hidden>
    <h2>Résultats</h2>
    <div class="kpi" id="kpiList"></div>
    <div class="sep"></div>
    <textarea id="debug" rows="14" class="mono" style="width:100%" readonly></textarea>
  </section>

  <!-- Sources -->
  <section class="card" data-panel="sources" hidden>
    <h2>Sources – Lien HTML direct (data.gouv) ou CSV/JSON</h2>
    <div class="grid">
      <div class="col-12">
        <label>URL de la source</label>
        <input id="api_url" value="https://www.data.gouv.fr/api/1/datasets/r/df7a9765-2ac9-45be-905f-d2bc5dc9fc35">
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn accent" id="btnLoadSource">Charger & Fusionner</button>
      <button class="btn" id="btnClearSources">Vider le cache des sources</button>
    </div>
    <div class="sep"></div>
    <h3>Journal (sources)</h3>
    <textarea id="sources_log" rows="10" class="mono" style="width:100%" readonly></textarea>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  /* ===== Helpers ===== */
  function norm(s){return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9%€\/\.\- ]+/g,"").replace(/\s+/g," ").trim();}
  const $=s=>document.querySelector(s), $$=s=>[].slice.call(document.querySelectorAll(s));
  const fmtEur=v=>isNaN(v)?'—':v.toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  function pmt(r,n,p){ if(r===0) return -(p/n); return -(p*(r)*Math.pow(1+r,n))/(Math.pow(1+r,n)-1); }
  function getNum(sel){ const el=$(sel); const v=el?parseFloat(el.value):NaN; return isNaN(v)?0:v; }
  function getStr(sel){ const el=$(sel); return el?String(el.value).trim():""; }
  function saveState(){ const inputs=[].slice.call(document.querySelectorAll("input,select")).reduce((a,el)=>{a[el.id]=el.value;return a;},{}); localStorage.setItem("immo_state_full", JSON.stringify(inputs)); }
  function loadState(){ const raw=localStorage.getItem("immo_state_full"); if(!raw) return; const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=document.getElementById(k); if(el) el.value=d[k]; }); }
  function append(id,msg){ const el=$(id); if(!el) return; el.value+=(el.value?"\n":"")+msg; el.scrollTop=el.scrollHeight; }

  /* ===== Tabs ===== */
  $("#tabs").addEventListener("click", e=>{
    const b=e.target.closest(".tab-btn"); if(!b) return;
    $$(".tab-btn").forEach(x=>x.classList.remove("active")); b.classList.add("active");
    $$("[data-panel]").forEach(p=> p.hidden = (p.dataset.panel!==b.dataset.tab));
  });

  /* ===== Référentiel fusionné ===== */
  let REF_ROWS = [];
  function describeRefShort(){
    return REF_ROWS.length ? `REF: ${REF_ROWS.length} lignes (source HTML/CSV/JSON).` : "Aucun référentiel chargé.";
  }

  /* ===== Heuristiques colonnes ===== */
  const CP_KEYS = ["cp","code postal","code_postal","postal code","code insee","insee","codgeo","codgeo commune"];
  const CITY_KEYS = ["ville","commune","city","nom_commune","nom","libelle","libellé"];
  const COL_HINTS = {
    tf_m2:["taxe fonciere €/m2","tf €/m2","tf m2","taxe fonciere m2","taxe_fonciere_m2","taxe_fonciere_eur_m2","tf_eur_m2","taxe fonciere (€ / m2)"],
    teom_m2:["teom €/m2","teom m2","teom_eur_m2","teom (€ / m2)"],
    teom_an:["teom annuelle (€)","teom €/an","teom an","teom","teom_eur_an"],
    charges_fixes_m:["charges fixes €/mois","charges mensuelles fixes (€)","charges fixes mensuelles","charges_fixes_mensuelles","charges fixes (eur/mois)","charges_fixes_eur_mois","fix costs"],
    gestion_pct:["gestion locative (% loyers)","gestion locative %","frais agence %","property management %","mgmt %","gestion_locative_pourcent","gestion % loyers","gestion (%)"],
    capex_pct:["provision capex (% loyers)","capex %","provision gros travaux %","capex_pourcent","provision capex (%)"],
    tension:["tension locative","dossiers/chambre","tension locative (dossiers/ch)","tension","dossiers_par_chambre"]
  };
  function getColIndex(headers, candidates){
    const H=headers.map(norm);
    for(let i=0;i<candidates.length;i++){
      const c=norm(candidates[i]);
      let idx=H.indexOf(c); if(idx>=0) return idx;
      idx=H.findIndex(h=>h.indexOf(c)>=0); if(idx>=0) return idx;
    }
    return -1;
  }
  function pickNumberFromRow(row,candidates){
    const keys=Object.keys(row); const idx=getColIndex(keys,candidates); if(idx<0) return null;
    const key=keys[idx]; const val=row[key]; const num=parseFloat(String(val).replace(',','.')); return isNaN(num)?null:num;
  }

  /* ===== Fusion helpers ===== */
  function normalizeRow(row){
    const out={};
    for(const k in row){ if(!Object.prototype.hasOwnProperty.call(row,k)) continue; out[k]=row[k]; out["__"+norm(k)]=row[k]; }
    return out;
  }
  function mergeIntoReferential(rows, sourceLabel){
    let added=0;
    for(let i=0;i<rows.length;i++){
      const flat=normalizeRow(rows[i]);
      flat.__sheet = sourceLabel || flat.__sheet || "API/HTML";
      REF_ROWS.push(flat); added++;
    }
    return added;
  }
  function findRefRowFor(city,cp){
    if(!REF_ROWS.length) return null;
    const cityN=norm(city), cpN=norm(cp);
    for(const r of REF_ROWS){
      for(const k of Object.keys(r)){
        if(CP_KEYS.map(norm).indexOf(norm(k))>=0){
          const v=norm(String(r[k]||""));
          if(cpN && v===cpN) return r;
        }
      }
    }
    for(const r2 of REF_ROWS){
      for(const k2 of Object.keys(r2)){
        if(CITY_KEYS.map(norm).indexOf(norm(k2))>=0){
          const v2=norm(String(r2[k2]||""));
          if(cityN && v2===cityN) return r2;
        }
      }
    }
    return null;
  }

  /* ===== CAPEX précis (DPE × Âge) ===== */
  function capexPctFromDPEandAge(dpe, year){
    const y = parseInt(year||0,10);
    const age = (y>0) ? Math.max(0, new Date().getFullYear()-y) : 40;
    const d = String(dpe||"D").toUpperCase();
    const ageBucket = (age<=10) ? "0_10" : (age<=30) ? "11_30" : (age<=60) ? "31_60" : "61p";
    const TABLE = {
      "A": { "0_10": 3,  "11_30": 4,  "31_60": 5,  "61p": 6  },
      "B": { "0_10": 3.5,"11_30": 5,  "31_60": 6,  "61p": 7.5},
      "C": { "0_10": 4,  "11_30": 6,  "31_60": 8,  "61p": 10 },
      "D": { "0_10": 5,  "11_30": 7.5,"31_60": 10, "61p": 12 },
      "E": { "0_10": 6,  "11_30": 9,  "31_60": 12, "61p": 15 },
      "F": { "0_10": 7,  "11_30": 11, "31_60": 14, "61p": 18 },
      "G": { "0_10": 8,  "11_30": 13, "31_60": 17, "61p": 22 }
    };
    const row = TABLE[d] || TABLE["D"];
    return row[ageBucket];
  }

  /* ===== Auto calculs via référentiel ===== */
  function autoFromReferential(){
    const city=getStr("#city"), cp=getStr("#cp"), surf=getNum("#surf"), year=getNum("#year"), dpe=getStr("#dpe");
    const row=findRefRowFor(city,cp);
    if(!row){ append("#debug","[Auto] Réf introuvable pour cette Ville/CP."); return; }

    const tf_m2=pickNumberFromRow(row,COL_HINTS.tf_m2);
    const teom_m2=pickNumberFromRow(row,COL_HINTS.teom_m2);
    const teom_an=pickNumberFromRow(row,COL_HINTS.teom_an);
    const fix_m=pickNumberFromRow(row,COL_HINTS.charges_fixes_m);
    const gest=pickNumberFromRow(row,COL_HINTS.gestion_pct);
    const capex=pickNumberFromRow(row,COL_HINTS.capex_pct);
    const tension=pickNumberFromRow(row,COL_HINTS.tension);

    if(tf_m2!=null && surf>0) $("#tf_annual").value = Math.round(tf_m2*surf);
    if(teom_m2!=null && surf>0) $("#teom_annual").value = Math.round(teom_m2*surf);
    if(teom_an!=null) $("#teom_annual").value = Math.round(teom_an);
    if(fix_m!=null) $("#fix_costs").value = Math.round(fix_m);

    $("#mgmt_pct").value = (gest!=null? gest.toFixed(2) : "7.00");
    $("#capex_pct").value = (capex!=null? capex.toFixed(2) : capexPctFromDPEandAge(dpe,year).toFixed(2));

    let occ1="0.90", occ2="1.00";
    if(tension!=null){
      if(tension>=5){ occ1="1.00"; occ2="1.00"; }
      else if(tension>=3){ occ1="0.90"; occ2="1.00"; }
      else if(tension>=2){ occ1="0.80"; occ2="0.90"; }
      else if(tension>=1){ occ1="0.70"; occ2="0.80"; }
      else { occ1="0.50"; occ2="0.70"; }
    }
    $("#occ_phase1").value=occ1; $("#occ_phase2").value=occ2;

    const rent = getNum("#rent_total") || (getNum("#rooms")*getNum("#rent_per_room"));
    if(!getNum("#other_annual") && rent){ $("#other_annual").value = Math.round(rent*12*0.05); }
    saveState();
  }

  /* ===== IR 2025 (revenus 2024) ===== */
  const IR2025_THRESHOLDS = [
    { upTo: 11497, rate: 0.00 },
    { upTo: 29315, rate: 0.11 },
    { upTo: 83823, rate: 0.30 },
    { upTo: 180294, rate: 0.41 },
    { upTo: Infinity, rate: 0.45 }
  ];
  function frenchIR2025(baseImposableAnnuel, parts){
    parts = Math.max(1, parts||1);
    const qp = baseImposableAnnuel / parts;
    let impPart = 0, prev = 0;
    for(let i=0;i<IR2025_THRESHOLDS.length;i++){
      const top = IR2025_THRESHOLDS[i].upTo;
      const rate = IR2025_THRESHOLDS[i].rate;
      const width = Math.max(0, Math.min(qp, top) - prev);
      if(width>0) impPart += width * rate;
      if(qp <= top) break;
      prev = top;
    }
    return impPart * parts;
  }

  /* ===== Résultats ===== */
  const KPI_LIST = [
    ["mode_fiscal","Mode fiscal actif"],
    ["revenus_brut_m","Revenus bruts mensuels"],
    ["revenus_brut_a","Revenus bruts annuels"],
    ["mensualite_banque","Mensualité banque (PMT)"],
    ["mensualite_sasu","Mensualité SASU (PMT)"],
    ["charges_mensuelles","Charges mensuelles (fixes+gestion+CAPEX+TEOM+autres/12)"],
    ["coupon_phase1","Coupon investisseur (phase 1) – intérêts SASU (mensuel)"],
    ["charges_tf_mois","Taxe foncière (mois)"],
    ["impots_cotisations_ann","Cotisations + IR (annuel)"],
    ["cashflow_m_ph1_occ1","Cash-flow net mensuel – Phase 1 (occ. auto)"],
    ["cashflow_a_ph2_occ1","Cash-flow net annuel – Phase 2 (occ. auto)"],
    ["cashflow_m_ph1_occ05","Cash-flow net mensuel – Phase 1 (occ. 50%)"],
    ["cashflow_a_ph2_occ05","Cash-flow net annuel – Phase 2 (occ. 50%)"]
  ];

  function computeResults(){
    const bankAmount=getNum("#bank_amount"), bankRate=getNum("#bank_rate")/100, bankYears=getNum("#bank_years");
    const sasuAmount=getNum("#sasu_amount"), sasuRate=getNum("#sasu_rate")/100, sasuYears=getNum("#sasu_years");
    const rooms=getNum("#rooms"), rpr=getNum("#rent_per_room"); let rentTotal=getNum("#rent_total"); if(!rentTotal && rooms && rpr){ rentTotal=rooms*rpr; $("#rent_total").value=rentTotal; }
    const occ1=parseFloat($("#occ_phase1").value||"1"), occ2=parseFloat($("#occ_phase2").value||"1");
    const fixCosts=getNum("#fix_costs"), tfAnnual=getNum("#tf_annual"), teomAnnual=getNum("#teom_annual"), otherAnnual=getNum("#other_annual");
    const mgmtPct=getNum("#mgmt_pct")/100, capexPct=getNum("#capex_pct")/100;
    const mode = getStr("#tax_mode") || "LMP";
    const NB_PARTS = Math.max(1, getNum("#nb_parts")||1);
    const COT_RATE = Math.max(0, getNum("#cot_rate")||35)/100;

    const bankM=pmt(bankRate/12, bankYears*12, bankAmount);
    const sasuM=pmt(sasuRate/12, sasuYears*12, sasuAmount);
    const mensualiteBanque=-bankM, mensualiteSASU=-sasuM;

    const RSASU_an = sasuAmount*sasuRate; // intérêts annuels (phase 1)
    const loyersA=rentTotal*12;
    const gestionA=rentTotal*mgmtPct*12, capexA=rentTotal*capexPct*12;
    const chargesA=(fixCosts*12)+tfAnnual+teomAnnual+otherAnnual+gestionA+capexA;

    /* ---- Fiscalité ---- */
    let baseImp, cotSoc, IR, baseIR, impLabel=mode;
    if(mode==="LMP"){
      // Amortissements
      const price = getNum("#price");
      const batiPct = Math.max(0, getNum("#amort_bati_pct")/100); const batiYears=Math.max(1,getNum("#amort_bati_years"));
      const mobPct  = Math.max(0, getNum("#amort_mob_pct")/100);  const mobYears =Math.max(1,getNum("#amort_mob_years"));
      const notPct  = Math.max(0, getNum("#amort_not_pct")/100);  const notYears =Math.max(1,getNum("#amort_not_years"));

      const amortBat = (price * batiPct) / batiYears;
      const amortMob = (price * mobPct)  / mobYears;
      const amortNot = (price * notPct)  / notYears;
      const amortTotal = amortBat + amortMob + amortNot;

      // intérêts annuels
      const interetsBanque = Math.max(0, (bankAmount * bankRate));
      const interetsSASU   = Math.max(0, (sasuAmount * sasuRate));

      // Résultat fiscal LMP
      baseImp = Math.max(0, loyersA - chargesA - amortTotal - interetsBanque - interetsSASU);
      cotSoc = baseImp * COT_RATE;
      baseIR = Math.max(0, baseImp - cotSoc);
      IR = frenchIR2025(baseIR, NB_PARTS);
      impLabel = `LMP (amort: ${Math.round(amortTotal).toLocaleString('fr-FR')} €/an)`;
    } else {
      // Simplifié (sans amortissement, cotis sur base loyer - charges)
      baseImp = Math.max(0, loyersA - chargesA);
      cotSoc = baseImp * COT_RATE;
      baseIR = Math.max(0, baseImp - cotSoc);
      IR = frenchIR2025(baseIR, NB_PARTS);
      impLabel = "Simplifié";
    }
    const impCotAn = cotSoc + IR;

    /* ---- Cashflows ---- */
    function net(occ,phase){
      const lOcc=loyersA*occ;
      const sasu = (phase===1)? RSASU_an : (mensualiteSASU*12);
      return lOcc - chargesA - (mensualiteBanque*12) - sasu - impCotAn;
    }

    const res = {
      mode_fiscal: impLabel,
      revenus_brut_m: rentTotal,
      revenus_brut_a: loyersA,
      mensualite_banque: mensualiteBanque,
      mensualite_sasu: mensualiteSASU,
      charges_mensuelles: (chargesA/12),
      coupon_phase1: RSASU_an/12,
      charges_tf_mois: (tfAnnual/12),
      impots_cotisations_ann: impCotAn,
      cashflow_m_ph1_occ1: net(occ1,1)/12,
      cashflow_a_ph2_occ1: net(occ2,2),
      cashflow_m_ph1_occ05: net(0.5,1)/12,
      cashflow_a_ph2_occ05: net(0.5,2)
    };
    const dbg = {mode,NB_PARTS,COT_RATE,baseImp,baseIR,IR,cotSoc,loyersA,chargesA,gestionA,capexA,RSASU_an,ref:describeRefShort()};
    return {res,dbg};
  }

  function renderKPIs(obj){
    const root=$("#kpiList"); root.innerHTML="";
    const moneyKeys=new Set(["revenus_brut_m","revenus_brut_a","mensualite_banque","mensualite_sasu","charges_mensuelles","coupon_phase1","charges_tf_mois","impots_cotisations_ann","cashflow_m_ph1_occ1","cashflow_a_ph2_occ1","cashflow_m_ph1_occ05","cashflow_a_ph2_occ05"]);
    for(let i=0;i<KPI_LIST.length;i++){
      const [key,label]=KPI_LIST[i];
      const v=obj[key];
      const isMoney=moneyKeys.has(key);
      const sign=(typeof v==="number" && (key.includes("cashflow")||key.includes("mensualite")||key.includes("charges")||key.includes("coupon")))?(v>=0?"pos":"neg"):"";
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML=`<h3>${label}</h3><div class="val ${sign}">${(isMoney?fmtEur(v):(v??"—"))}</div>`;
      root.appendChild(el);
    }
  }

  /* ===== HTML / CSV / JSON loader ===== */
  const SRC_CACHE_KEY="immo_api_sources_v1";
  function looksLikeJSON(t){ t=String(t||"").trim(); return t[0]==="{"||t[0]==="["; }
  function isHTML(t){ const s=String(t||"").trim().slice(0,200).toLowerCase(); return s.includes("<!doctype html")||s.includes("<html"); }
  function parseHTMLTablesToRows(htmlText){
    const parser=new DOMParser();
    const doc=parser.parseFromString(htmlText,"text/html");
    const tables=[].slice.call(doc.querySelectorAll("table"));
    const rows=[];
    tables.forEach(tbl=>{
      const trs=[].slice.call(tbl.querySelectorAll("tr"));
      if(!trs.length) return;
      let headers=[]; const ths=trs[0].querySelectorAll("th,td");
      if(ths.length>=2){
        headers=[].slice.call(ths).map(th=>th.textContent.trim());
        for(let i=1;i<trs.length;i++){
          const cells=[].slice.call(trs[i].querySelectorAll("td,th"));
          if(!cells.length) continue;
          const obj={}; cells.forEach((c,idx)=>{ obj[headers[idx]||("col_"+idx)] = c.textContent.trim(); });
          rows.push(obj);
        }
      } else {
        trs.forEach(tr=>{
          const cells=[].slice.call(tr.querySelectorAll("td,th")); if(!cells.length) return;
          const obj={}; cells.forEach((c,idx)=>{ obj["col_"+idx]=c.textContent.trim(); }); rows.push(obj);
        });
      }
    });
    return rows;
  }
  async function fetchAsText(url){ const res=await fetch(url,{mode:"cors"}); if(!res.ok) throw new Error("HTTP "+res.status); return await res.text(); }

  $("#btnLoadSource").addEventListener("click", async ()=>{
    const url=getStr("#api_url"); if(!url){ alert("URL requise."); return; }
    try{
      append("#sources_log","Chargement: "+url);
      const text=await fetchAsText(url);
      let rows=[];
      if(isHTML(text)){ rows=parseHTMLTablesToRows(text); append("#sources_log",`→ HTML détecté: ${rows.length} lignes extraites`); }
      else if(looksLikeJSON(text)){ const json=JSON.parse(text); rows=Array.isArray(json)?json:(Array.isArray(json.items)?json.items:[]); append("#sources_log",`→ JSON: ${rows.length}`); }
      else { const parsed=Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true}); rows=parsed.data; append("#sources_log",`→ CSV: ${rows.length}`); }
      const added=mergeIntoReferential(rows,"API/HTML"); append("#sources_log",`Fusion: +${added}, total=${REF_ROWS.length}`);
      // cache URL
      let cache=JSON.parse(localStorage.getItem(SRC_CACHE_KEY)||"[]"); if(cache.indexOf(url)<0){ cache.push(url); localStorage.setItem(SRC_CACHE_KEY, JSON.stringify(cache)); }
      // recalcul
      autoFromReferential(); const out=computeResults(); renderKPIs(out.res); $("#debug").value=JSON.stringify(out.dbg,null,2);
    }catch(err){ append("#sources_log","❌ "+(err&&err.message?err.message:err)); }
  });
  $("#btnClearSources").addEventListener("click",()=>{ localStorage.removeItem(SRC_CACHE_KEY); append("#sources_log","Cache vidé."); });

  // Préchargement de TON lien
  (async function preload(){
    const url="https://www.data.gouv.fr/api/1/datasets/r/df7a9765-2ac9-45be-905f-d2bc5dc9fc35";
    try{
      const t=await fetchAsText(url);
      let rows=[];
      if(isHTML(t)){ rows=parseHTMLTablesToRows(t); append("#sources_log",`Préchargé (HTML): ${rows.length} lignes`); }
      else if(looksLikeJSON(t)){ const j=JSON.parse(t); rows=Array.isArray(j)?j:(Array.isArray(j.items)?j.items:[]); append("#sources_log",`Préchargé (JSON): ${rows.length}`); }
      else { const p=Papa.parse(t,{header:true,dynamicTyping:true,skipEmptyLines:true}); rows=p.data; append("#sources_log",`Préchargé (CSV): ${rows.length}`); }
      mergeIntoReferential(rows,"API/HTML");
    }catch(e){ append("#sources_log","Préchargement KO: "+e.message); }
  })();

  /* ===== Actions ===== */
  $("#calcBtn").addEventListener("click", ()=>{ autoFromReferential(); const out=computeResults(); renderKPIs(out.res); $("#debug").value=JSON.stringify(out.dbg,null,2); });
  $("#saveBtn").addEventListener("click", ()=>{ saveState(); alert("Données sauvegardées (local)"); });
  $("#resetBtn").addEventListener("click", ()=>{ localStorage.removeItem("immo_state_full"); location.reload(); });
  $$(".card input, .card select").forEach(el=> el.addEventListener("change", saveState));

  /* ===== Init ===== */
  loadState();
  const dbg=$("#debug");
  if(dbg) dbg.value="Saisis Ville/CP/Surface puis clique Recalculer. Le mode LMP utilise des amortissements paramétrables. La source HTML est préchargée.";
});
</script>
</body>
</html>
