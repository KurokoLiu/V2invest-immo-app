<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invest_IMMO – Import Excel auto (multi-feuilles)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f1222; --fg:#f3f5ff; --muted:#aeb3d0; --card:#171a2e; --accent:#6ea8fe; --accent2:#9c6efe;
    --ok:#3ddc84; --warn:#ffc857; --bad:#ff6b6b; --line:#252947;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  header{padding:18px 22px;border-bottom:1px solid var(--line);display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 40px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
  .tab-btn{padding:10px 14px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:10px;cursor:pointer}
  .tab-btn.active{outline:2px solid var(--accent);color:#fff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
  label{display:block;margin:0 0 6px;color:var(--muted);font-size:13px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);background:#111428;color:var(--fg);border-radius:8px}
  input::placeholder{color:#6d7394}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:1px solid var(--line);background:#111428;color:#fff;border-radius:10px;cursor:pointer}
  .btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
  .btn.ghost{background:transparent}
  .kpi{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .kpi .item{grid-column:span 6;background:#111428;border:1px solid var(--line);border-radius:12px;padding:14px}
  .kpi h3{margin:0 0 6px;font-size:14px;color:var(--muted)}
  .val{font-size:20px;font-weight:700}
  .pos{color:var(--ok)} .neg{color:var(--bad)}
  .foot{margin-top:12px;color:var(--muted);font-size:12px}
  .readonly{opacity:.9;user-select:text}
  .sticky-actions{position:sticky;bottom:0;padding:12px;background:linear-gradient(180deg,rgba(15,18,34,0),rgba(15,18,34,.9) 30%,rgba(15,18,34,1) 60%);display:flex;gap:10px;justify-content:flex-end}
  .sep{height:1px;background:var(--line);margin:16px 0}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
  @media (max-width:900px){ .col-6{grid-column:span 12} .col-4{grid-column:span 12} .col-3{grid-column:span 6} .kpi .item{grid-column:span 12}}
</style>
</head>
<body>
<header>
  <h1>Invest_IMMO • Import auto depuis Excel</h1>
  <span class="pill">Sauvegarde locale</span>
  <span class="pill">Calculs en direct</span>
  <button class="btn" id="importXlsBtn">Importer ton Excel</button>
  <input type="file" id="xlsFile" accept=".xlsx,.xls" hidden />
  <button class="btn ghost" id="resetBtn">Réinitialiser</button>
</header>

<div class="wrap">
  <nav class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="param">Paramètres financiers</button>
    <button class="tab-btn" data-tab="saisie">Saisie (bien)</button>
    <button class="tab-btn" data-tab="result">Résultats</button>
    <button class="tab-btn" data-tab="refs">Référentiels (affichage)</button>
  </nav>

  <!-- Paramètres -->
  <section class="card" data-panel="param">
    <h2 style="margin-top:0">Paramètres financiers</h2>
    <div class="grid">
      <div class="col-6">
        <label>Montant prêt banque (€)</label>
        <input type="number" step="100" id="bank_amount" placeholder="ex. 550000" />
      </div>
      <div class="col-3">
        <label>Taux banque (% annuel)</label>
        <input type="number" step="0.01" id="bank_rate" placeholder="ex. 4.20" />
      </div>
      <div class="col-3">
        <label>Durée prêt banque (années)</label>
        <input type="number" step="1" id="bank_years" placeholder="ex. 20" />
      </div>

      <div class="col-6">
        <label>Avance SASU (€)</label>
        <input type="number" step="100" id="sasu_amount" placeholder="ex. 100000" />
      </div>
      <div class="col-3">
        <label>Taux SASU (% annuel)</label>
        <input type="number" step="0.01" id="sasu_rate" placeholder="ex. 3.00" />
      </div>
      <div class="col-3">
        <label>Durée SASU (années)</label>
        <input type="number" step="1" id="sasu_years" placeholder="ex. 7" />
      </div>

      <div class="col-3">
        <label>Taux d’imposition effectif (%)</label>
        <input type="number" step="0.1" id="tax_rate" placeholder="ex. 15" />
      </div>
      <div class="col-3">
        <label>Gestion locative (% loyers)</label>
        <input type="number" step="0.1" id="mgmt_pct" placeholder="ex. 7" />
      </div>
      <div class="col-3">
        <label>Provision CAPEX (% loyers)</label>
        <input type="number" step="0.1" id="capex_pct" placeholder="ex. 10" />
      </div>

      <div class="col-3">
        <label>Taux occupation Phase 1</label>
        <select id="occ_phase1">
          <option value="1">1.00 (100%)</option>
          <option value="0.9">0.90</option>
          <option value="0.8">0.80</option>
          <option value="0.7">0.70</option>
          <option value="0.5">0.50</option>
        </select>
      </div>
      <div class="col-3">
        <label>Taux occupation Phase 2</label>
        <select id="occ_phase2">
          <option value="1">1.00 (100%)</option>
          <option value="0.9">0.90</option>
          <option value="0.8">0.80</option>
          <option value="0.7">0.70</option>
          <option value="0.5">0.50</option>
        </select>
      </div>
    </div>
    <div class="foot mono">
      Mensualités calculées via PMT (classique). Les références affichées se synchronisent avec ces paramètres.
    </div>
  </section>

  <!-- Saisie bien -->
  <section class="card" data-panel="saisie" hidden>
    <h2 style="margin-top:0">Saisie (bien)</h2>
    <div class="grid">
      <div class="col-6">
        <label>Ville</label>
        <input id="city" placeholder="ex. Joinville-le-Pont" />
      </div>
      <div class="col-6">
        <label>Adresse</label>
        <input id="address" placeholder="ex. 3 rue Exemple" />
      </div>
      <div class="col-4">
        <label>Prix d’achat FAI (€)</label>
        <input type="number" step="1000" id="price" placeholder="ex. 550000" />
      </div>
      <div class="col-4">
        <label>Surface habitable (m²)</label>
        <input type="number" step="1" id="surf" placeholder="ex. 160" />
      </div>
      <div class="col-4">
        <label>Surface terrain (m²)</label>
        <input type="number" step="1" id="land" placeholder="ex. 300" />
      </div>
      <div class="col-3">
        <label>DPE</label>
        <input id="dpe" placeholder="ex. D" />
      </div>
      <div class="col-3">
        <label>Année de construction</label>
        <input type="number" step="1" id="year" placeholder="ex. 1975" />
      </div>
      <div class="col-3">
        <label>Chambres louables (nb)</label>
        <input type="number" step="1" id="rooms" placeholder="ex. 6" />
      </div>
      <div class="col-3">
        <label>Loyer/chambre (€)</label>
        <input type="number" step="10" id="rent_per_room" placeholder="ex. 650" />
      </div>
      <div class="col-3">
        <label>Loyer total mensuel (€)</label>
        <input type="number" step="10" id="rent_total" placeholder="Auto si vide: chambres × loyer/ch." />
      </div>

      <div class="col-3">
        <label>Charges mensuelles fixes (€)</label>
        <input type="number" step="10" id="fix_costs" placeholder="eau/élec/gaz/internet…" />
      </div>
      <div class="col-3">
        <label>Taxe foncière annuelle (€)</label>
        <input type="number" step="10" id="tf_annual" placeholder="ex. 2200" />
      </div>
      <div class="col-3">
        <label>TEOM annuelle (€)</label>
        <input type="number" step="10" id="teom_annual" placeholder="ex. 400" />
      </div>
      <div class="col-3">
        <label>Autres charges annuelles (€)</label>
        <input type="number" step="10" id="other_annual" placeholder="copro, syndic, etc." />
      </div>
    </div>
    <div class="sticky-actions">
      <button class="btn" id="saveBtn">Enregistrer</button>
      <button class="btn accent" id="calcBtn">Recalculer</button>
    </div>
  </section>

  <!-- Résultats -->
  <section class="card" data-panel="result" hidden>
    <h2 style="margin-top:0">Résultats</h2>
    <div class="kpi" id="kpiList"></div>
    <div class="sep"></div>
    <div class="grid">
      <div class="col-12">
        <label>Journal de calcul (debug)</label>
        <textarea id="debug" rows="10" readonly class="mono readonly"></textarea>
      </div>
    </div>
  </section>

  <!-- Référentiels -->
  <section class="card" data-panel="refs" hidden>
    <h2 style="margin-top:0">Référentiels (lecture seule)</h2>
    <div class="grid">
      <div class="col-6">
        <div class="card">
          <h3 style="margin-top:0">Barème / variables</h3>
          <ul class="mono" id="refVars">
            <li>Taux impôt effectif : <span data-ref="tax_rate">—</span> %</li>
            <li>Gestion locative : <span data-ref="mgmt_pct">—</span> % loyers</li>
            <li>Provision CAPEX : <span data-ref="capex_pct">—</span> % loyers</li>
            <li>Occupation phase 1 : <span data-ref="occ_phase1">—</span></li>
            <li>Occupation phase 2 : <span data-ref="occ_phase2">—</span></li>
          </ul>
          <div class="hint">Synchronisé depuis Paramètres.</div>
        </div>
      </div>
      <div class="col-6">
        <div class="card">
          <h3 style="margin-top:0">Infos bien (résumé)</h3>
          <div class="mono" id="refBien">—</div>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
/*** ========= Helpers ========= ***/
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const fmtEur = v => isNaN(v)? '—' : v.toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});

function pmt(ratePerPeriod, nPeriods, presentValue){
  if(ratePerPeriod===0) return -(presentValue/nPeriods);
  const r = ratePerPeriod;
  return -(presentValue * r * Math.pow(1+r, nPeriods)) / (Math.pow(1+r, nPeriods)-1);
}
function getNum(sel){ const v = parseFloat($(sel).value); return isNaN(v)?0:v; }
function getStr(sel){ return $(sel).value?.trim()||""; }
function saveState(){
  const inputs = $$("input, select").reduce((acc,el)=>{ acc[el.id]=el.value; return acc; },{});
  localStorage.setItem("invest_immo_state_v2", JSON.stringify(inputs));
}
function loadState(){
  const raw = localStorage.getItem("invest_immo_state_v2");
  if(!raw) return;
  const data = JSON.parse(raw);
  Object.entries(data).forEach(([k,v])=>{ const el = document.getElementById(k); if(el) el.value = v; });
}
function resetState(){
  localStorage.removeItem("invest_immo_state_v2");
  $$("input").forEach(el=>el.value="");
  $$("select").forEach(el=>{ if(el.options.length) el.selectedIndex=0; });
  renderRefs(); renderKPIs({}); $("#debug").value="";
}

/*** ========= Navigation ========= ***/
$("#tabs").addEventListener("click", (e)=>{
  const btn = e.target.closest(".tab-btn"); if(!btn) return;
  $$(".tab-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  const tab = btn.dataset.tab;
  $$("[data-panel]").forEach(p=>p.hidden = (p.dataset.panel!==tab));
});

/*** ========= Calculs ========= ***/
const KPI_ORDER = [
  ["coupon_phase1","Coupon investisseur (phase 1) – intérêts SASU (mensuel)"],
  ["coupon_phase2","Coupon investisseur (phase 2) – mensualité SASU (PMT)"],
  ["charges_tf_mois","Charges + TF / mois (part TF)"],
  ["revenus_brut_m","Revenus bruts mensuels"],
  ["revenus_brut_a","Revenus bruts annuels"],
  ["mensualite_banque","Mensualité banque (PMT)"],
  ["mensualite_sasu","Mensualité SASU (PMT)"],
  ["charges_mensuelles","Charges mensuelles (fixes+gestion+CAPEX+TEOM+autres/12)"],
  ["cashflow_m_ph1_occ1","Cash-flow net mensuel après impôt – Phase 1 (occupation = 1)"],
  ["cashflow_a_ph2_occ1","Cash-flow net annuel après impôt – Phase 2 (occupation = 1)"],
  ["cashflow_m_ph1_occ05","Cash-flow net mensuel après impôt – Phase 1 (occupation = 0.5)"],
  ["cashflow_a_ph2_occ05","Cash-flow net annuel après impôt – Phase 2 (occupation = 0.5)"]
];

function compute(){
  const bankAmount = getNum("#bank_amount");
  const bankRateA = getNum("#bank_rate")/100;
  const bankYears = getNum("#bank_years");
  const sasuAmount = getNum("#sasu_amount");
  const sasuRateA = getNum("#sasu_rate")/100;
  const sasuYears = getNum("#sasu_years");
  const taxRate = getNum("#tax_rate")/100;
  const mgmtPct = getNum("#mgmt_pct")/100;
  const capexPct = getNum("#capex_pct")/100;

  const rooms = getNum("#rooms");
  const rentPerRoom = getNum("#rent_per_room");
  let rentTotal = getNum("#rent_total");
  if(rentTotal===0 && rooms>0 && rentPerRoom>0){
    rentTotal = rooms * rentPerRoom; $("#rent_total").value = rentTotal.toString();
  }

  const fixCosts = getNum("#fix_costs");
  const tfAnnual = getNum("#tf_annual");
  const teomAnnual = getNum("#teom_annual");
  const otherAnnual = getNum("#other_annual");

  const bankM = pmt(bankRateA/12, bankYears*12, bankAmount);
  const sasuM = pmt(sasuRateA/12, sasuYears*12, sasuAmount);

  const couponPhase1 = sasuAmount * (sasuRateA/12);
  const couponPhase2 = -sasuM;

  const gestion = rentTotal * mgmtPct;
  const capex = rentTotal * capexPct;
  const chargesMensuelles = fixCosts + gestion + capex + (tfAnnual/12) + (teomAnnual/12) + (otherAnnual/12);

  const revenusMensuels = rentTotal;
  const revenusAnnuels = rentTotal * 12;

  const mensualiteBanque = -bankM;
  const mensualiteSASU = -sasuM;

  function netAfterTax(monthlyRev, occ, phase){
    const rev = monthlyRev * occ;
    const interetsBanqueEstimes = bankAmount * (bankRateA/12);
    const interetsSASU_Ph1 = couponPhase1;
    const depensesBase = chargesMensuelles + mensualiteBanque;
    const depensesPhase = phase===1 ? (depensesBase + interetsSASU_Ph1) : (depensesBase + mensualiteSASU);
    const resultatAvantImp = rev - depensesPhase;
    const baseImposable = Math.max(0, rev - (chargesMensuelles + interetsBanqueEstimes + (phase===1? interetsSASU_Ph1 : mensualiteSASU)));
    const impots = baseImposable * taxRate;
    const net = resultatAvantImp - impots;
    return {net, impots, details:{rev, depensesPhase, baseImposable, interetsBanqueEstimes}};
  }

  const ph1_occ1 = netAfterTax(revenusMensuels, 1.0, 1);
  const ph2_occ1 = netAfterTax(revenusMensuels, 1.0, 2);
  const ph1_occ05 = netAfterTax(revenusMensuels, 0.5, 1);
  const ph2_occ05 = netAfterTax(revenusMensuels, 0.5, 2);

  return {
    coupon_phase1: couponPhase1,
    coupon_phase2: couponPhase2,
    charges_tf_mois: (tfAnnual/12),
    revenus_brut_m: revenusMensuels,
    revenus_brut_a: revenusAnnuels,
    mensualite_banque: mensualiteBanque,
    mensualite_sasu: mensualiteSASU,
    charges_mensuelles: chargesMensuelles,
    cashflow_m_ph1_occ1: ph1_occ1.net,
    cashflow_a_ph2_occ1: ph2_occ1.net*12,
    cashflow_m_ph1_occ05: ph1_occ05.net,
    cashflow_a_ph2_occ05: ph2_occ05.net*12,
    dbg: {inputs:{
      bankAmount,bankRateA,bankYears,sasuAmount,sasuRateA,sasuYears,taxRate,mgmtPct,capexPct,
      rooms,rentPerRoom,rentTotal,fixCosts,tfAnnual,teomAnnual,otherAnnual
    }}
  };
}

function renderKPIs(res){
  const root = $("#kpiList");
  root.innerHTML = "";
  const moneyKeys = new Set(["coupon_phase1","coupon_phase2","charges_tf_mois","revenus_brut_m","revenus_brut_a","mensualite_banque","mensualite_sasu","charges_mensuelles","cashflow_m_ph1_occ1","cashflow_a_ph2_occ1","cashflow_m_ph1_occ05","cashflow_a_ph2_occ05"]);
  KPI_ORDER.forEach(([key,label])=>{
    const val = res[key];
    const sign = (typeof val==="number" && (key.startsWith("cashflow")||key.startsWith("coupon")||key.startsWith("mensualite")||key.startsWith("charges"))) ? (val>=0?"pos":"neg") : "";
    const display = moneyKeys.has(key) ? fmtEur(val) : (typeof val==="number"? val.toLocaleString("fr-FR") : "—");
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `<h3>${label}</h3><div class="val ${sign}">${display}</div>`;
    root.appendChild(el);
  });
  $("#debug").value = JSON.stringify(res.dbg, null, 2);
}

function renderRefs(){
  $("[data-ref='tax_rate']").textContent = $("#tax_rate").value || "—";
  $("[data-ref='mgmt_pct']").textContent = $("#mgmt_pct").value || "—";
  $("[data-ref='capex_pct']").textContent = $("#capex_pct").value || "—";
  $("[data-ref='occ_phase1']").textContent = $("#occ_phase1").value || "—";
  $("[data-ref='occ_phase2']").textContent = $("#occ_phase2").value || "—";

  const parts = [
    ["Ville", getStr("#city")],
    ["Adresse", getStr("#address")],
    ["Prix", fmtEur(getNum("#price"))],
    ["Surface", (getNum("#surf")? getNum("#surf")+" m²":"—")],
    ["Terrain", (getNum("#land")? getNum("#land")+" m²":"—")],
    ["DPE", getStr("#dpe")||"—"],
    ["Année", getStr("#year")||"—"],
    ["Chambres", getStr("#rooms")||"—"],
    ["Loyer/ch.", (getNum("#rent_per_room")? fmtEur(getNum("#rent_per_room")):"—")],
    ["Loyer total", (getNum("#rent_total")? fmtEur(getNum("#rent_total")):"—")]
  ];
  $("#refBien").innerHTML = parts.map(([k,v])=>`<div><b>${k} :</b> ${v}</div>`).join("");
}

/*** ========= Sauvegarde / Events ========= ***/
$("#saveBtn").addEventListener("click", ()=>{ saveState(); renderRefs(); });
$("#calcBtn").addEventListener("click", ()=>{ saveState(); renderRefs(); renderKPIs(compute()); });
$("#resetBtn").addEventListener("click", ()=>{ resetState(); });

$$("input,select,textarea").forEach(el=>{
  el.addEventListener("change", ()=>{ saveState(); });
});

/*** ========= Import Excel – AUTO multi-feuilles + synonymes ========= ***/
// normalise accents/espaces/casse
const norm = s => (String(s||"")
  .toLowerCase()
  .normalize('NFD')
  .replace(/\p{Diacritic}/gu,'')
  .replace(/[^a-z0-9%€\/\.\- ]+/g,'')
  .replace(/\s+/g,' ')
  .trim()
);

// dictionnaire de cibles => synonymes possibles (FR/EN tolérés)
const FIELD_SYNONYMS = {
  bank_amount: [
    "montant du pret banque","montant pret banque","montant pret (banque)","loan amount","bank amount","montant du pret (banque)"
  ],
  bank_rate: [
    "taux banque","taux du pret banque","interet banque %","bank rate","taux nominal banque","taux dinteret banque"
  ],
  bank_years: [
    "duree du pret (annees)","duree pret banque (annees)","duree banque","loan years","duree du credit (annees)"
  ],
  sasu_amount: [
    "avance sasu (€)","avance sasu","montant avance sasu","sasu amount","pret intra groupe sasu"
  ],
  sasu_rate: [
    "taux sasu (%)","taux sasu","interest sasu","sasu rate"
  ],
  sasu_years: [
    "duree sasu (annees)","duree sasu","sasu years"
  ],
  tax_rate: [
    "taux dimposition effectif (%)","taux dimposition effectif","taux impot effectif","taux impot","tax rate"
  ],
  mgmt_pct: [
    "gestion locative (% loyers)","gestion locative %","frais dagence %","property management %","mgmt %"
  ],
  capex_pct: [
    "provision capex (% loyers)","capex %","provision gros travaux %"
  ],
  city: [
    "ville","city"
  ],
  address: [
    "adresse","address"
  ],
  price: [
    "prix dachat frais compris","prix dachat fai (€)","prix dachat","prix fai","price"
  ],
  surf: [
    "surface habitable (m²)","surface habitable","surface"
  ],
  land: [
    "surface terrain (m²)","surface terrain","terrain"
  ],
  dpe: [
    "dpe","diagnostic dpe","classe dpe"
  ],
  year: [
    "annee de construction","annee construction","year built","construction year"
  ],
  rooms: [
    "nombre de chambres louables","nb chambres louables","nb chambres","chambres louables"
  ],
  rent_per_room: [
    "loyer/chambre (€)","loyer par chambre","loyer chambre","rent per room"
  ],
  rent_total: [
    "loyer total mensuel (€)","loyer total mensuel","revenus bruts mensuels","monthly rent total","loyer total"
  ],
  fix_costs: [
    "charges mensuelles fixes (€)","charges mensuelles fixes","charges fixes mensuelles"
  ],
  tf_annual: [
    "taxe fonciere annuelle (€)","taxe fonciere annuelle","taxe fonciere","tf annuelle"
  ],
  teom_annual: [
    "teom annuelle (€)","teom annuelle","teom"
  ],
  other_annual: [
    "autres charges annuelles (€)","autres charges annuelles","autres charges / an"
  ]
};

// test exact + contient
function findHeaderIndex(headers, wantedList){
  // headers: array of normalised header strings
  const wanted = wantedList.map(norm);
  // exact match
  for(let i=0;i<wanted.length;i++){
    const idx = headers.findIndex(h => h === wanted[i]);
    if(idx>=0) return idx;
  }
  // contains
  for(let i=0;i<wanted.length;i++){
    const idx = headers.findIndex(h => h.includes(wanted[i]));
    if(idx>=0) return idx;
  }
  return -1;
}

function firstNonEmptyRowAfter(headersRowIndex, rows){
  for(let r=headersRowIndex+1; r<rows.length; r++){
    const row = rows[r] || [];
    if(row.some(v => v!==null && v!==undefined && String(v).trim()!=="")) return r;
  }
  return -1;
}

$("#importXlsBtn").addEventListener("click", ()=> $("#xlsFile").click());
$("#xlsFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const wb = XLSX.read(arrayBuffer, {type:"array"});

  const log = [];
  let filledCount = 0;
  // Parcours toutes les feuilles
  for(const wsName of wb.SheetNames){
    const ws = wb.Sheets[wsName];
    // lis brute (tableau de tableaux) pour détecter la ligne d'en-têtes
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!aoa || !aoa.length) continue;

    // trouve la ligne dont au moins 3 cellules non vides = en-têtes
    let headerRowIdx = -1;
    for(let r=0; r<Math.min(20, aoa.length); r++){
      const nonEmpty = (aoa[r]||[]).filter(x => String(x).trim()!=="").length;
      if(nonEmpty>=3){ headerRowIdx = r; break; }
    }
    if(headerRowIdx<0) continue;

    const rawHeaders = (aoa[headerRowIdx] || []).map(h => String(h));
    const headersNorm = rawHeaders.map(h => norm(h));
    const dataRowIdx = firstNonEmptyRowAfter(headerRowIdx, aoa);
    if(dataRowIdx<0) continue;
    const dataRow = aoa[dataRowIdx] || [];

    // pour chaque champ cible, essaie de trouver l'index de colonne
    Object.entries(FIELD_SYNONYMS).forEach(([fieldId, synonyms])=>{
      // si déjà rempli, ne pas écraser (priorité à la 1ère correspondance)
      const el = document.getElementById(fieldId);
      if(!el) return;
      if(el.value && String(el.value).trim()!=="") return;

      const idx = findHeaderIndex(headersNorm, synonyms);
      if(idx>=0 && dataRow[idx] !== undefined && String(dataRow[idx]).trim()!==""){
        el.value = dataRow[idx];
        filledCount++;
        log.push(`Feuille "${wsName}": ${fieldId} ← "${rawHeaders[idx]}" = ${dataRow[idx]}`);
      }
    });
  }

  saveState(); renderRefs(); renderKPIs(compute());
  $("#debug").value = `Import terminé. Champs remplis: ${filledCount}\n\n` + log.join("\n");
  alert(`Import terminé depuis ${wb.SheetNames.length} feuille(s). ${filledCount} champ(s) détecté(s) et rempli(s).`);
});

/*** ========= Init ========= ***/
loadState();
renderRefs();
const initState = JSON.parse(localStorage.getItem("invest_immo_state_v2")||"{}");
if(Object.keys(initState).length){ renderKPIs(compute()); } else { renderKPIs({}); }
</script>
</body>
</html>
